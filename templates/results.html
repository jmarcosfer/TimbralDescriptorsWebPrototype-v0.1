{% extends "index.html" %}

{% block results %}
	<div id="wrapper">
		<div id="container">
			<div id="content_full">
				<div id="sidebar" style="float:right">
					<div class="content_box">
						<div>
							<h3>Audio Commons Timbral Descriptors</h3>
							{% for descriptor in descriptor_stats.keys() %}
							<h4 style="font-size:60%;text-align:center;">{{format_name(descriptor)}}</h4>
							<div id={{descriptor}} class="slider-block"></div>
							{% endfor %}
						</div>
						
					</div>
				</div>
				<div class="search_paginator">

				</div>
				<p>Here are some {{ query_string }} sounds! Enjoy!</p>
				{% for embed_link in results %}
					<div class="sample_player_small">
						<iframe frameborder="0" scrolling="no" src={{embed_link}} width="481" height="86"></iframe>
					</div>
				{% endfor %}
			</div>
		</div>
	</div>

	<script>
		let queryString = "{{ query_string }}";
		let sliders = Array.from(document.getElementsByClassName("slider-block"));
		let descriptorStats = {{ descriptor_stats|tojson }};

		sliders.forEach((slider, index) => {
			let descriptorName = slider.id;
			let sliderStats = descriptorStats[descriptorName];
			noUiSlider.create(slider, {
				start: [sliderStats["25%"], sliderStats["75%"]],
				connect: true,
				range: {
					'min': sliderStats["25%"],
					'max': sliderStats["75%"]
				}
			});

			// add event handler function:

			slider.noUiSlider.on("change", function() {
				sliderValues = slider.noUiSlider.get();
				let searchURL = `${window.location.origin}/search?q=${queryString}&f=${descriptorName}%3A%5B${sliderValues[0]} TO ${sliderValues[1]}%5D`

				let xhr = new XMLHttpRequest();
				xhr.addEventListener('load', function() {
					if (this.status == 200 && this.readyState == 4) {
						window.location = this.responseURL;
					}
				});
				xhr.open("GET", searchURL, true);
				xhr.send(null);
			});
		});

	</script>

{% endblock %}